# AIZoomDoc Server

Backend API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é LLM –≤ –∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ.

## –û–ø–∏—Å–∞–Ω–∏–µ

AIZoomDoc Server ‚Äî —ç—Ç–æ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. –°–µ—Ä–≤–µ—Ä –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ —Å—Ç–∞—Ç–∏—á–Ω–æ–º—É —Ç–æ–∫–µ–Ω—É —Å –≤—ã–¥–∞—á–µ–π JWT
- üí¨ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏ –∏ –¥–∏–∞–ª–æ–≥–∞–º–∏ —Å LLM
- ü§ñ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Google Gemini API (per-user –∫–ª—é—á–∏)
- üìÅ –†–∞–±–æ—Ç—É —Å —Ñ–∞–π–ª–∞–º–∏ —á–µ—Ä–µ–∑ S3/R2 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- üå≥ –î–æ—Å—Ç—É–ø –∫ –¥–µ—Ä–µ–≤—É –ø—Ä–æ–µ–∫—Ç–æ–≤ (read-only)
- ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (simple/complex —Ä–µ–∂–∏–º, —Ä–æ–ª–∏)
- üîÑ WebSocket streaming –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ LLM

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
aizoomdoc-server/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ config.py            # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ models/              # Pydantic –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.py          # API –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ internal.py     # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ routers/            # API —Ä–æ—É—Ç–µ—Ä—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py         # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.py         # –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prompts.py      # –ü—Ä–æ–º–ø—Ç—ã –∏ —Ä–æ–ª–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chats.py        # –ß–∞—Ç—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ files.py        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ projects.py     # –î–µ—Ä–µ–≤–æ –ø—Ä–æ–µ–∫—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ core/               # –Ø–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py         # JWT —É—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dependencies.py # FastAPI dependencies
‚îÇ   ‚îú‚îÄ‚îÄ db/                 # –ö–ª–∏–µ–Ω—Ç—ã –ë–î –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supabase_client.py          # –û—Å–Ω–æ–≤–Ω–∞—è –ë–î (—á–∞—Ç—ã)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supabase_projects_client.py # –ë–î –ø—Ä–æ–µ–∫—Ç–æ–≤ (read-only)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ s3_client.py                # S3/R2 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
‚îÇ   ‚îî‚îÄ‚îÄ services/           # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (TODO)
‚îÇ       ‚îú‚îÄ‚îÄ llm_service.py  # –†–∞–±–æ—Ç–∞ —Å Gemini
‚îÇ       ‚îú‚îÄ‚îÄ search_service.py # –ü–æ–∏—Å–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
‚îÇ       ‚îú‚îÄ‚îÄ image_service.py  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚îÇ       ‚îî‚îÄ‚îÄ agent_service.py  # –ü–∞–π–ø–ª–∞–π–Ω –∞–≥–µ–Ω—Ç–∞
‚îú‚îÄ‚îÄ migrations/             # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ 001_create_users_prompts_settings.sql
‚îú‚îÄ‚îÄ requirements.txt        # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ env.example            # –ü—Ä–∏–º–µ—Ä .env —Ñ–∞–π–ª–∞
‚îî‚îÄ‚îÄ README.md              # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git clone <repo-url>
cd aizoomdoc-server

# –°–æ–∑–¥–∞–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `env.example` –≤ `.env` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```bash
cp env.example .env
```

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `JWT_SECRET_KEY` ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è JWT (—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–æ–∫—É)
- `SUPABASE_URL`, `SUPABASE_SERVICE_KEY` ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ë–î (—á–∞—Ç—ã, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
- `SUPABASE_PROJECTS_URL`, `SUPABASE_PROJECTS_SERVICE_KEY` ‚Äî –ë–î –ø—Ä–æ–µ–∫—Ç–æ–≤ (read-only)
- `R2_ENDPOINT_URL`, `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY` ‚Äî S3/R2 —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- `DEFAULT_GEMINI_API_KEY` ‚Äî –∫–ª—é—á Gemini –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –≤–∞—à–µ–π Supabase –ë–î:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ Supabase –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ
psql <your-supabase-connection-string> < migrations/001_create_users_prompts_settings.sql
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Supabase Dashboard: SQL Editor ‚Üí –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –º–∏–≥—Ä–∞—Ü–∏–∏.

### 4. –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π, –æ–±–Ω–æ–≤–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```sql
-- –û–±–Ω–æ–≤–∏—Ç–µ content –ø—Ä–æ–º–ø—Ç–æ–≤ –∏–∑ —Ñ–∞–π–ª–æ–≤ data/*.txt
UPDATE prompts_system 
SET content = '<—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ llm_system_prompt.txt>' 
WHERE name = 'llm_system';

-- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è json_annotation, html_ocr, flash_extractor
```

## –ó–∞–ø—É—Å–∫

### –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
python -m app.main
# –∏–ª–∏
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### –ü—Ä–æ–¥–∞–∫—à–Ω

```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:8000`

## API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å–∞–º:
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

```http
POST /auth/exchange
Content-Type: application/json

{
  "static_token": "your-static-token"
}

# –û—Ç–≤–µ—Ç
{
  "access_token": "eyJ...",
  "token_type": "bearer",
  "expires_in": 3600,
  "user": {
    "id": "uuid",
    "username": "admin",
    "status": "active",
    "created_at": "2026-01-13T00:00:00Z"
  }
}
```

#### –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```http
GET /me
Authorization: Bearer <access_token>

# –û—Ç–≤–µ—Ç
{
  "user": { ... },
  "settings": {
    "model_profile": "simple",
    "selected_role_prompt_id": null
  },
  "gemini_api_key_configured": false
}
```

#### –°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞

```http
POST /chats
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "title": "–ê–Ω–∞–ª–∏–∑ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏–∏",
  "description": "–í–æ–ø—Ä–æ—Å—ã –ø–æ —Å–∏—Å—Ç–µ–º–µ –í2"
}
```

#### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

```http
POST /chats/{chat_id}/messages
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "content": "–ö–∞–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ –í2?"
}
```

#### WebSocket —Å—Ç—Ä–∏–º–∏–Ω–≥

```javascript
const ws = new WebSocket('ws://localhost:8000/chats/{chat_id}/stream?token=<access_token>');

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('Event:', data.event, data.data);
};
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã –º–æ–¥–µ–ª–∏

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –¥–≤—É—Ö —Ä–µ–∂–∏–º–æ–≤:

- **simple** (flash) ‚Äî –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º —Å –æ–¥–Ω–æ–π –º–æ–¥–µ–ª—å—é Gemini Flash
- **complex** (flash+pro) ‚Äî –¥–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π —Ä–µ–∂–∏–º:
  1. Flash —Å–æ–±–∏—Ä–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  2. Pro —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç

### –†–æ–ª–∏ (–ø—Ä–æ–º–ø—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ä–æ–ª—å –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤:
- –ò–Ω–∂–µ–Ω–µ—Ä
- –≠–∫–æ–Ω–æ–º–∏—Å—Ç
- –ò–Ω–∂–µ–Ω–µ—Ä –ø–æ –≥–∞—Ä–∞–Ω—Ç–∏–∏
- –ë–µ–∑ —Ä–æ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

–†–æ–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `user_prompts`.

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω–∞—è –ë–î (bd.json)

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`users`)
- –ß–∞—Ç–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π (`chats`, `chat_messages`)
- –ù–∞—Å—Ç—Ä–æ–µ–∫ (`settings`)
- –ü—Ä–æ–º–ø—Ç–æ–≤ (`prompts_system`, `user_prompts`)
- –§–∞–π–ª–æ–≤ (`storage_files`)

### –ë–î –ø—Ä–æ–µ–∫—Ç–æ–≤ (bd_supabase.json) ‚Äî read-only

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- –î–µ—Ä–µ–≤–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ (`tree_nodes`)
- –§–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (`node_files`)
- OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ TODO

- [x] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É FastAPI –ø—Ä–æ–µ–∫—Ç–∞
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Auth (StaticToken ‚Üí JWT)
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Supabase –∞–¥–∞–ø—Ç–µ—Ä—ã
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å S3/R2 –∞–¥–∞–ø—Ç–µ—Ä
- [x] –°–æ–∑–¥–∞—Ç—å API endpoints
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Gemini LLM –∫–ª–∏–µ–Ω—Ç (per-user keys)
- [ ] –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å Search Engine –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- [ ] –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å Image Processor
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Chat pipeline (simple + complex)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å WebSocket streaming

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **LLM Service** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Gemini API —Å per-user –∫–ª—é—á–∞–º–∏
2. **Search Service** ‚Äî –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
3. **Image Service** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, zoom, quadrants
4. **Agent Service** ‚Äî –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
5. **WebSocket** ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —Å–æ–±—ã—Ç–∏–π

## –õ–∏—Ü–µ–Ω–∑–∏—è

Proprietary

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: [–≤–∞—à email]

