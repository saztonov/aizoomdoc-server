# Дополнения к ТЗ: Портал RD + AIDoc

**Дата**: 2026-01-19  
**Версия**: 1.2  
**Статус**: На согласование  

---

## 1. Введение

Настоящий документ содержит дополнения и уточнения к ТЗ "Портал RD (подготовка документации) + AIDoc (LLM-анализ)" с учётом **текущего состояния реализации** клиент-серверного приложения aizoomdoc-v2 по состоянию на январь 2026 года.

**Ключевые акценты работ:**
1. **Аудит и оптимизация** — анализ архитектуры, code review, рефакторинг
2. **Веб-интерфейс** — перенос RD в web, создание единого портала
3. **Интеграция** — объединение RD-prep и AIDoc-analyze через BFF

---

## 2. Текущее состояние реализации

### 2.1. AIDoc-analyze (aizoomdoc-v2) — backend

| Компонент | Статус | Описание |
|-----------|--------|----------|
| **AgentService** | ✅ Готов | Оркестратор пайплайна (simple/complex/compare режимы) |
| **LLMService** | ✅ Готов | Интеграция Gemini (строгий JSON, per-user ключи, thinking mode) |
| **EvidenceService** | ✅ Готов | Рендеринг PDF→PNG, квадранты, ROI, LRU-кэш |
| **SearchService** | ✅ Готов | Парсинг MD-блоков, построение block_map |
| **SSE Streaming** | ✅ Готов | События pipeline, image_ready, очередь запросов |
| **QueueService** | ✅ Готов | Управление параллельными LLM-запросами |
| **DeletionService** | ✅ Готов | Фоновое каскадное удаление |
| **База знаний** | ✅ Готов | Интеграция в контекст через AgentService |

### 2.2. RD (подготовка документации) — desktop

| Компонент | Статус | Описание |
|-----------|--------|----------|
| PDF Viewer | ✅ Готов | PySide6, PyMuPDF |
| Разметка блоков | ✅ Готов | TEXT/TABLE/IMAGE, координаты px+norm |
| Автосегментация | ✅ Готов | Marker, Datalab API, эвристики |
| OCR | ✅ Готов | VLM (Qwen), Chandra |
| Удаление штампов | ✅ Готов | Анализ структуры PDF |
| Экспорт | ✅ Готов | MD, HTML, JSON, кропы |

### 2.3. Python-клиент (aizoomdoc-client-py)

**Статус**: ✅ Реализован (CLI + GUI на PyQt6)

---

## 3. Аудит и оптимизация архитектуры (ВЫСОКИЙ ПРИОРИТЕТ)

### 3.1. Области анализа

#### 3.1.1. Архитектура кода

| Аспект | Что анализировать |
|--------|-------------------|
| Границы модулей | Чёткость разделения ответственности между сервисами |
| Зависимости | Циклические зависимости, tight coupling |
| Дублирование | Повторяющийся код, отсутствие общих абстракций |
| Расширяемость | Возможность добавления новых функций без переписывания |
| Конфигурация | Управление настройками, environment variables |

#### 3.1.2. Качество кода

| Аспект | Что анализировать |
|--------|-------------------|
| Type hints | Полнота аннотаций типов |
| Docstrings | Документация функций и классов |
| Обработка ошибок | Try/except, логирование, graceful degradation |
| Naming | Именование переменных, функций, классов |
| Complexity | Цикломатическая сложность, длина функций |

#### 3.1.3. Производительность

| Аспект | Что анализировать |
|--------|-------------------|
| I/O операции | Блокирующие вызовы, async/await |
| Кэширование | Эффективность LRU-кэша, cache invalidation |
| Память | Memory leaks, большие объекты в памяти |
| Параллелизм | Использование asyncio, очереди |
| Латентность | Узкие места в pipeline (LLM, рендеринг, S3) |

#### 3.1.4. Безопасность

| Аспект | Что анализировать |
|--------|-------------------|
| Секреты | Хранение API ключей, паролей |
| Авторизация | Проверки прав доступа на всех уровнях |
| Валидация | Входные данные, file uploads |
| Изоляция | Разделение данных между пользователями/клиентами |
| Логирование | Чувствительные данные в логах |

#### 3.1.5. Тестируемость

| Аспект | Что анализировать |
|--------|-------------------|
| Инъекция зависимостей | Возможность подмены компонентов |
| Изоляция | Независимость тестов друг от друга |
| Mocking | Возможность mock внешних сервисов (S3, LLM, Supabase) |
| Покрытие | Критические пути, edge cases |

### 3.2. Ожидаемые артефакты аудита

| Артефакт | Содержание |
|----------|------------|
| **Отчёт аудита** | Перечень проблем с классификацией: severity, impact, effort |
| **Карта зависимостей** | Визуализация связей между модулями |
| **Backlog** | Приоритизированный список задач на рефакторинг |
| **ADR** | Архитектурные решения для значимых изменений |
| **Рекомендации** | Предложения по оптимизации без немедленной реализации |

### 3.3. Рефакторинг (по результатам аудита)

| Категория | Примеры задач |
|-----------|---------------|
| Дефекты | Race conditions, memory leaks, edge cases |
| Архитектура | Вынос общей логики, интерфейсы, DI |
| Производительность | Оптимизация hot paths, batching |
| Код | Упрощение сложных функций, унификация стиля |

---

## 4. Веб-интерфейс (ВЫСОКИЙ ПРИОРИТЕТ)

### 4.1. RD-web (модуль подготовки)

Перенос десктопного приложения RD (PySide6) в веб-интерфейс:

| Функция | Сложность | Приоритет |
|---------|-----------|-----------|
| Просмотр PDF (canvas, zoom, pan) | Высокая | Критичный |
| Рисование блоков (overlay) | Высокая | Критичный |
| Типы блоков (TEXT/TABLE/IMAGE) | Средняя | Критичный |
| Автосегментация (Marker/Datalab) | Средняя | Высокий |
| OCR по блокам (VLM/Chandra) | Средняя | Высокий |
| Удаление штампов | Высокая | Средний |
| Экспорт результатов (MD, кропы) | Низкая | Критичный |

**Технические требования:**
- Canvas-based рендеринг PDF (pdf.js или аналог)
- Overlay для рисования/редактирования блоков
- Двойная система координат (px + normalized)
- Прогресс-индикация для длительных операций

### 4.2. AIDoc-web (модуль анализа)

Веб-клиент для существующего backend:

| Функция | Сложность | Приоритет |
|---------|-----------|-----------|
| Чат с историей | Низкая | Критичный |
| Выбор документов из дерева | Средняя | Критичный |
| SSE-стриминг ответа | Средняя | Критичный |
| Отображение image_ready | Средняя | Высокий |
| Режим сравнения (DOC_A vs DOC_B) | Средняя | Средний |
| Настройки (роль, режим, thinking) | Низкая | Средний |

**Технические требования:**
- Обработка SSE-событий (phase_started, image_ready, llm_final)
- Галерея изображений с привязкой к block_id
- Markdown-рендеринг ответов с citations

### 4.3. Единый портал

| Требование | Описание |
|------------|----------|
| Единая навигация | Переключение между модулями RD / AIDoc |
| Единый список проектов | Общее дерево документов |
| Единая авторизация | JWT через BFF |
| Единый UX/UI стиль | Консистентный дизайн |

---

## 5. Интеграция (СРЕДНИЙ ПРИОРИТЕТ)

### 5.1. BFF / API Gateway

| Требование | Описание |
|------------|----------|
| Маршрутизация | Проксирование к RD-prep и AIDoc-analyze |
| Авторизация | Единая точка auth, выдача JWT |
| Агрегация | Объединённые модели для UI |
| Формат ошибок | Унифицированный (error_code, message, trace_id) |
| Rate limiting | Защита от abuse |

### 5.2. Унификация данных

| Аспект | Текущее состояние | Целевое состояние |
|--------|-------------------|-------------------|
| Пользователи | Supabase (chats) | Единая таблица users |
| Проекты | Projects DB (read-only) | Унифицированное API |
| Документы | file_type в projects | Стандартный PreparedDocumentPackage |

---

## 6. Уточнения к ТЗ

### 6.1. Tool calls (раздел 5.4)

В текущей реализации используется **server-side tool execution**:
- LLM возвращает JSON с `followup_images` и `followup_rois`
- Сервер интерпретирует и выполняет запросы
- Повторный вызов LLM с обновлённым контекстом

Это отличается от классического "function calling" и должно быть задокументировано.

### 6.2. События streaming (раздел 7.2.3)

Реализованные события требуют поддержки в web-клиенте:

| Событие | Назначение | UI-реакция |
|---------|------------|------------|
| `phase_started` | Начало фазы | Индикатор этапа |
| `image_ready` | Изображение готово | Добавить в галерею |
| `llm_final` | Финальный ответ | Отобразить Markdown |
| `tool_call` | Вызов инструмента | Индикатор "запрос изображений" |
| `queue_position` | Позиция в очереди | Уведомление ожидания |

### 6.3. Режим сравнения (новое)

Backend поддерживает сравнение двух наборов документов:
- `compare_document_ids_a`, `compare_document_ids_b` в запросе
- Ответ содержит `diff: List[DiffItem]` с полями before/after/impact
- UI должен отображать таблицу различий

---

## 7. Требования к тестированию

| Уровень | Покрытие | Приоритет |
|---------|----------|-----------|
| Unit-тесты | Парсеры, форматы, tool calls | Высокий |
| Integration-тесты | API endpoints, upload, chat flow | Высокий |
| E2E-сценарии | Критические пути портала | Средний |

**Критические сценарии для E2E:**
1. Загрузка PDF → разметка → OCR → экспорт
2. Выбор документа → вопрос → получение ответа с изображениями
3. Сравнение двух версий документа

---

## 8. Оценка трудоёмкости

### 8.1. Аудит и оптимизация

| Этап | Оценка | Комментарий |
|------|--------|-------------|
| Discovery / анализ архитектуры | 16-24 часа | Review кода, карта зависимостей |
| Отчёт и рекомендации | 8-16 часов | Документирование, backlog |
| Рефакторинг | По результатам | Зависит от объёма выявленных проблем |

### 8.2. Web-интерфейс

| Модуль | Оценка | Комментарий |
|--------|--------|-------------|
| RD-web (PDF viewer + разметка) | 80-120 часов | Canvas, overlay, координаты |
| RD-web (OCR, автосегментация) | 40-60 часов | Интеграция с backend |
| AIDoc-web (чат + стриминг) | 40-60 часов | SSE, галерея, Markdown |
| Портал (навигация, авторизация) | 20-30 часов | Обёртка, роутинг |

### 8.3. Интеграция

| Компонент | Оценка | Комментарий |
|-----------|--------|-------------|
| BFF (базовый) | 16-24 часа | Проксирование, auth |
| Унификация API | 8-16 часов | Формат ошибок, версионирование |

---

## 9. Заключение

### 9.1. Что уже готово

- **AIDoc-analyze backend** — реализован на ~90% от требований ТЗ
- **RD desktop** — полностью функционален
- **Python-клиент** — CLI + GUI

### 9.2. Основные задачи подрядчика

1. **Аудит**: Анализ архитектуры, code review, выявление проблем
2. **Оптимизация**: Рефакторинг по результатам аудита
3. **Web-интерфейс**: Перенос RD в web, создание AIDoc-web, единый портал
4. **Интеграция**: BFF, унификация API
5. **Тестирование**: Unit/integration/E2E на критические сценарии

### 9.3. Вне scope

- Полнотекстовый поиск в Supabase (не требуется для текущих сценариев)

---

**Автор**: AI Assistant  
**Дата создания**: 2026-01-19  
**Последнее обновление**: 2026-01-19 (v1.2)
